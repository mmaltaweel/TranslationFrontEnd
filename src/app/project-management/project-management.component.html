<p-toast></p-toast>

<div class="card">
    <p-toolbar styleClass="p-mb-4">
        <ng-template pTemplate="left">
            <button pButton pRipple label="New Project" icon="pi pi-plus" class="p-button-success p-mr-2"
                (click)="openNew()"></button>
        </ng-template>
    </p-toolbar>

    <p-table #dt [loading]="loading" [value]="projects" [paginator]="true" [lazy]="true" [rows]="rows" [totalRecords]="totalRecords" (onLazyLoad)="getProjects($event)"
        [globalFilterFields]="['name','country.name','representative.name','status']" [rowHover]="true" dataKey="id"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)"
        [showCurrentPageReport]="true">
        <ng-template pTemplate="caption">

        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 4rem"></th>
                <th >Name </th>
                <th> Start Date  </th>
                <th> End Date</th>
                <th> Description  </th>
                <th> Status </th>
                <th> progress </th>
                <th></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-project let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="project" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td>{{project.name}}</td>
                <td>{{ project.startDate | date:'shortDate' }}</td>
                <td>{{ project.endDate | date:'shortDate' }}</td>
                <td>{{project.description}}</td>
                <td>
                    <p-tag [value]="project.statusDisplayName" [severity]="getSeverity(project.statusDisplayName)" />
                </td>
                <td>
                    
                    <p-progressBar [value]="project.progress" [showValue]="true" />
                </td>
                <td>
                    <button  pTooltip="Edit Project" 
                    tooltipPosition="top" pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-primary p-mr-2"
                    [disabled]="project.status === 1" (click)="editProject(project)"></button>

                    <button  pTooltip="Delete Project" 
                    tooltipPosition="top" [disabled]="project.status === 1"  pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning"
                        (click)="deleteProject(project)"></button>

                    <button   pTooltip="Mark project as completed" 
                    tooltipPosition="top" pButton pRipple icon="pi pi-check" class="p-button-rounded p-button-success"
                    (click)="markProjectAsCompleted(project)"
                    [disabled]="project.status === 1"></button>

                
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-project>
            <tr>
                <td colspan="7">
                    <div class="p-3">
                        <p-toolbar styleClass="p-mb-4">
                            <ng-template pTemplate="left">
                                <button pButton pRipple label="New Task" icon="pi pi-plus" class="p-button-success p-mr-2"
                                    (click)="openNewTask()"></button>
                            </ng-template>
                        </p-toolbar>
                        <p-table [value]="project.tasks" dataKey="id">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th pSortableColumn="id">Id <p-sortIcon field="id" /></th>
                                    <th pSortableColumn="title">Title <p-sortIcon field="title" /></th>
                                    <th pSortableColumn="description">Description <p-sortIcon field="description" /></th>
                                    <th pSortableColumn="dueDate">DueDate <p-sortIcon field="dueDate" /></th>
                                    <th pSortableColumn="assignedTranslator">Assigned Translator <p-sortIcon field="assignedTranslator" /></th>
                                    <th pSortableColumn="statusDisplayName">Status <p-sortIcon field="statusDisplayName"></p-sortIcon></th>

                                    <th style="width: 4rem"></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-task>
                                <tr>
                                    <td>{{ task.id }}</td>
                                    <td>{{ task.title }}</td>
                                    <td>{{ task.description }}</td>
                                    <td>{{ task.dueDate | date:'shortDate' }}</td>
                                    <td>{{ task.assignedTranslator }}</td>
                                    <td>
                                        <p-tag [value]="task.statusDisplayName" [severity]="getSeverity(task.statusDisplayName)" />
                                    </td>
                                    <td>
                                        <button  pTooltip="Edit Task" 
                                        tooltipPosition="top" [disabled]="project.status === 1" pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success p-mr-2"
                                            (click)="editTask(task)"></button>
                                        <button  pTooltip="Delete Task" 
                                        tooltipPosition="top" [disabled]="project.status === 1"  pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning"
                                            (click)="deleteTask(task)"></button>
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="6">There are no task for this project yet.</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="summary">
            <div class="p-d-flex p-ai-center p-jc-between">
                In total there are {{projects ? totalRecords : 0 }} projects.
            </div>
        </ng-template>
    </p-table>
</div>

<p-dialog [(visible)]="projectDialog" [style]="{width: '450px'}" header="Project Details" [modal]="true"
    styleClass="p-fluid">
    <ng-template pTemplate="content">
        <div class="p-field">
            <label for="name">Name</label>
            <input type="text" pInputText id="name" [(ngModel)]="project.name" required autofocus />
            <small class="p-invalid redText" *ngIf="submitted && (!project.name || project.name.trim() === '')">
                Name is required.
              </small>
        </div>
        <div class="p-field">
            <label for="description">Description</label>
            <textarea id="description" pInputTextarea [(ngModel)]="project.description" required rows="3"
                cols="20"></textarea>
                <small class="p-invalid redText" *ngIf="submitted && (!project.description || project.description.trim() === '')">
                    Description is required.
                  </small>
        </div>
        <div class="p-formgrid p-grid">
            <div class="p-field p-col">
                <label for="startDate">Start Date</label>
                <p-calendar required dateFormat="dd-mm-yy" appendTo="body" id="startDate" [(ngModel)]="project.startDate" inputId="icon"></p-calendar>
                <small class="p-invalid redText" *ngIf="submitted && !project.startDate && !isValidDate(project.startDate)">StartDate is required.</small>
            </div>
            <div class="p-field p-col">
                <label for="endDate">End Date</label>
                <p-calendar required dateFormat="dd-mm-yy" id="endDate" [(ngModel)]="project.endDate" inputId="icon"></p-calendar>
                <small class="p-invalid redText" *ngIf="submitted && !project.endDate && !isValidDate(project.endDate)">EndDate is required.</small>

            </div>
            <small class="p-invalid redText" *ngIf="isEndDateLessThanStart(project.startDate,project.endDate)">
                Start Date should be earlier than End Date.
              </small>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Create" icon="pi pi-check" class="p-button-text" (click)="saveProject()"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="taskDialog" [style]="{width: '450px'}" header="Task Details" [modal]="true"
    styleClass="p-fluid">
    <ng-template pTemplate="content">
        <div class="p-field">
            <label for="title">title</label>
            <input type="text" pInputText id="title" [(ngModel)]="task.title" required autofocus />
            <small class="p-invalid redText" *ngIf="submitted && (!task.title || task.title.trim() === '')">
                Title is required.
              </small>
        </div>
        <div class="p-field">
            <label for="description">Description</label>
            <textarea id="description" pInputTextarea [(ngModel)]="task.description" required rows="3"
                cols="20"></textarea>
                <small class="p-invalid redText" *ngIf="submitted && (!task.description || task.description.trim() === '')">
                    Description is required.
                  </small>
        </div>
        <div class="p-formgrid p-grid">
            <div class="p-field p-col">
                <label for="dueDate">Due  Date</label>
                <p-calendar required dateFormat="dd-mm-yy" appendTo="body" id="dueDate" [(ngModel)]="task.dueDate" inputId="icon"></p-calendar>
                <small class="p-invalid redText" *ngIf="submitted && !task.dueDate && !isValidDate(task.dueDate)">Due Date is required.</small>
            </div>
            <div class="p-field p-col">
                <label for="assignedTranslatorId">Translator</label>
                <p-dropdown 
                    [options]="translators" 
                    [(ngModel)]="task.assignedTranslatorId"
                    [checkmark]="true" 
                    optionValue="id"
                    optionLabel="userName" 
                    [showClear]="true" 
                    placeholder="Select a Translator" />
                 <small class="p-invalid redText" *ngIf="submitted && !task.assignedTranslatorId && isStringInvalid(task.assignedTranslatorId)">Translator is required.</small>

            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Create" icon="pi pi-check" class="p-button-text" (click)="saveTask()"></button>
    </ng-template>
</p-dialog>


<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>